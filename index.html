<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
</head>
<body>
  <button>Get Bluetooth</button>
  <script>
    var characteristic;

    var button = document.querySelector('button');
    button.addEventListener('click', async function() {
      try {
        const serviceUuid = '0000ffe0-0000-1000-8000-00805f9b34fb';
        const characteristicUuid = '0000ffe1-0000-1000-8000-00805f9b34fb';
        console.log('Requesting Bluetooth Device...');

        const device = await navigator.bluetooth.requestDevice({
          filters: [{services: [serviceUuid]}],
        })
        console.log('Connecting to GATT Server...');
        const server = await device.gatt.connect();

        console.log('Getting Service...');
        const service = await server.getPrimaryService(serviceUuid);
        console.log('Getting Characteristic...');
        characteristic = await service.getCharacteristic(characteristicUuid);
        await characteristic.startNotifications();
        console.log('> Notifications started');
        characteristic.addEventListener('characteristicvaluechanged', handleNotifications);
      } catch (err) {
        console.error(err);
        console.error(err.message);
      }
    });
    
    function convert(v) {
      return v * 0.0140625 + 32;
    }

    function handleNotifications(event) {
      let value = event.target.value;
      // Convert raw data bytes to hex values just for the sake of showing something.
      // In the "real" world, you'd use data.getUint8, data.getUint16 or even
      // TextDecoder to process raw data bytes.
      if (value.byteLength === 20) {
        for (let offset = 0; offset += 10; offset < 20) {
          let i = 0;
          // id
          let id = '';
          for (; i < 6; i++) {
            id += ('00' + value.getInt8(offset + i).toString(16)).slice(-2);
          }
          // temp
          const temp = convert(value.getInt16((offset + i) / 2));
          console.log(id, temp);
        }
      }
    }
  </script>
</body>
</html>

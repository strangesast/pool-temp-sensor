<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
</head>
<body>
  <button>Get Bluetooth</button>
  <script>
    var characteristic;

    var button = document.querySelector('button');
    button.addEventListener('click', async function() {
      const serviceUuid = '0000ffe0-0000-1000-8000-00805f9b34fb';
      const characteristicUuid = '0000ffe1-0000-1000-8000-00805f9b34fb';
      console.log('Requesting Bluetooth Device...');

      const device = await navigator.bluetooth.requestDevice({
        filters: [{services: [serviceUuid]}],
      })
      console.log('Connecting to GATT Server...');
      const server = await device.gatt.connect();

      console.log('Getting Service...');
      const service = await server.getPrimaryService(serviceUuid);
      console.log('Getting Characteristic...');
      characteristic = await service.getCharacteristic(characteristicUuid);
      await characteristic.startNotifications();
      console.log('> Notifications started');
      characteristic.addEventListener('characteristicvaluechanged', handleNotifications);
    });
    
    function convert(v) {
      return v * 0.0140625 + 32;
    }

    function handleNotifications(event) {
      let value = event.target.value;
      if (value.byteLength === 20) {
        for (let offset = 0; offset += 10; offset < 20) {
          try {
            let i = 0;
            // id
            let id = '';
            for (; i < 6; i+=2) {
              id += ('0'.repeat(4) + value.getUint16(offset + i).toString(16)).slice(-4);
            }
            // temp
            const temp = convert(value.getInt16(offset + i));
            console.log(id, temp);
          } catch (err) {
            console.log('failed with', value.buffer);
            console.error(err);
            characteristic.removeEventListener('characteristicvaluechanged', handleNotifications);
          }
        }
      }
    }
  </script>
</body>
</html>

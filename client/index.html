<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
  <style>
    svg text.temperature {
      font-family: sans-serif;
      font-size: 40px;
      alignment-baseline: middle;
      text-anchor: middle;
    }
  </style>
</head>
<body>
  <button>Get Bluetooth</button>
  <pre></pre>
  <svg width="1000" height="1000"></svg>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script>
    var characteristic;

    var button = document.querySelector('button');
    button.addEventListener('click', async function() {
      const serviceUuid = '0000ffe0-0000-1000-8000-00805f9b34fb';
      const characteristicUuid = '0000ffe1-0000-1000-8000-00805f9b34fb';
      console.log('Requesting Bluetooth Device...');

      const device = await navigator.bluetooth.requestDevice({
        filters: [{services: [serviceUuid]}],
      })
      console.log('Connecting to GATT Server...');
      const server = await device.gatt.connect();

      console.log('Getting Service...');
      const service = await server.getPrimaryService(serviceUuid);
      console.log('Getting Characteristic...');
      characteristic = await service.getCharacteristic(characteristicUuid);
      await characteristic.startNotifications();
      console.log('> Notifications started');
      characteristic.addEventListener('characteristicvaluechanged', handleNotifications);
    });
    
    function convert(v) {
      return v * 0.0140625 + 32;
    }

    function handleNotifications(event) {
      let value = event.target.value;
      if (value.byteLength === 20) {
        const obj = {};

        const id0 = Array.from(new Uint16Array(value.buffer.slice(0, 6)), v => ('0'.repeat(4) + v.toString(16)).slice(-4)).join('');
        const temp0 = convert(value.getInt16(6));
        obj[id0] = temp0;

        const id1 = Array.from(new Uint16Array(value.buffer.slice(10, 16)), v => ('0'.repeat(4) + v.toString(16)).slice(-4)).join('');
        const temp1 = convert(value.getInt16(16));
        obj[id1] = temp1;

        document.querySelector('pre').textContent = JSON.stringify(obj, null, 2);

        const min = 40;
        const max = 100;
        foreground.transition()
            .duration(750)
            .attrTween("d", arcTween(-2 / 3 * Math.PI + (temp0 - min) / (max - min) * 2 / 3 * tau));

        text.text(temp0);
      }
    }

    var tau = 2 * Math.PI; // http://tauday.com/tau-manifesto
    
    // An arc function with all values bound except the endAngle. So, to compute an
    // SVG path string for a given angle, we pass an object with an endAngle
    // property to the `arc` function, and it will return the corresponding string.
    var arc = d3.arc()
        .innerRadius(180)
        .outerRadius(240)
        .startAngle(-Math.PI * 2 / 3);
    
    // Get the SVG container, and apply a transform such that the origin is the
    // center of the canvas. This way, we donâ€™t need to position arcs individually.
    var svg = d3.select(document.querySelector('svg')),
        width = +svg.attr("width"),
        height = +svg.attr("height"),
        g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
    
    // Add the background arc, from 0 to 100% (tau).
    var background = g.append("path")
        .datum({endAngle: Math.PI * 2 / 3})
        .style("fill", "#ddd")
        .attr("d", arc);

    var title = g.append('text').classed('title', true).text('IN');
    var text = g.append('text').classed('temperature', true).text(72.5);
    
    // Add the foreground arc in orange, currently showing 12.7%.
    var foreground = g.append("path")
        .datum({endAngle: 0.127 * tau})
        .style("fill", "orange")
        .attr("d", arc);
    
    function arcTween(newAngle) {
      return function(d) {
        var interpolate = d3.interpolate(d.endAngle, newAngle);
        return function(t) {
          d.endAngle = interpolate(t);
          return arc(d);
        };
      };
    }
  </script>
</body>
</html>
